%function returns Jacobian of 7DOF KUKA iiwa robot
%input:
%Q   - vector of robot configuration 
%      Q = [q11,q12, ... q1n]
%          [q21,q22, ... q2n]
%          [... ...  ... ...]
%          [qm1,qm2, ... qmn]
%       where m - number of experiments
%             n - number of joints
%Pi  - vector of geometric parameters of the robot 
%      Pi = [l1,l2, ... ln]
%Tbase - transformation matrix of base
%Ttool - transformation matrix of tool
%output:
%J   - jacobian matrix
%      J = [dq1/dx,   d12/dx,    ... ... d1m/dx1  ]
%          [ ... ... ... ... ... ... ... ... ...  ]
%          [dq1/dphiz,d12/dphiz, ... ... d1m/dphiz]
function out = Jacobian_7DOF(Q,Pi,Tbase,Ttool)

T0 = ForwardKinematics_7DOF(Q,Pi,Tbase,Ttool);
T0(1:3,4) = [0;0;0];
T0 = T0';

Td = Tbase*...
    Rzd(Q(1)+Pi(1))*...
    Ry(Q(2)+Pi(2))*Tz(Pi(8))*...
    Rz(Q(3)+Pi(3))*...
    Ry(Q(4)+Pi(4))*Tz(Pi(9))*...
    Rz(Q(5)+Pi(5))*...
    Ry(Q(6)+Pi(6))*...
    Rz(Q(7)+Pi(7))*...
    Ttool*T0;
% J1 = [Td(1,4), Td(2,4), Td(3,4), Td(3,2), Td(1,3), Td(2,1)]' ;
J1 = [Td(1,4), Td(2,4), Td(3,4)]' ;

Td = Tbase*...
    Rz(Q(1)+Pi(1))*...
    Ryd(Q(2)+Pi(2))*Tz(Pi(8))*...
    Rz(Q(3)+Pi(3))*...
    Ry(Q(4)+Pi(4))*Tz(Pi(9))*...
    Rz(Q(5)+Pi(5))*...
    Ry(Q(6)+Pi(6))*...
    Rz(Q(7)+Pi(7))*...
    Ttool*T0;
% J2 = [Td(1,4), Td(2,4), Td(3,4), Td(3,2), Td(1,3), Td(2,1)]' ;
J2 = [Td(1,4), Td(2,4), Td(3,4)]' ;

Td = Tbase*...
    Rz(Q(1)+Pi(1))*...
    Ry(Q(2)+Pi(2))*Tz(Pi(8))*...
    Rzd(Q(3)+Pi(3))*...
    Ry(Q(4)+Pi(4))*Tz(Pi(9))*...
    Rz(Q(5)+Pi(5))*...
    Ry(Q(6)+Pi(6))*...
    Rz(Q(7)+Pi(7))*...
    Ttool*T0;
% J3 = [Td(1,4), Td(2,4), Td(3,4), Td(3,2), Td(1,3), Td(2,1)]' ;
J3 = [Td(1,4), Td(2,4), Td(3,4)]' ;

Td = Tbase*...
    Rz(Q(1)+Pi(1))*...
    Ry(Q(2)+Pi(2))*Tz(Pi(8))*...
    Rz(Q(3)+Pi(3))*...
    Ryd(Q(4)+Pi(4))*Tz(Pi(9))*...
    Rz(Q(5)+Pi(5))*...
    Ry(Q(6)+Pi(6))*...
    Rz(Q(7)+Pi(7))*...
    Ttool*T0;
% J4 = [Td(1,4), Td(2,4), Td(3,4), Td(3,2), Td(1,3), Td(2,1)]' ;
J4 = [Td(1,4), Td(2,4), Td(3,4)]' ;

Td = Tbase*...
    Rz(Q(1)+Pi(1))*...
    Ry(Q(2)+Pi(2))*Tz(Pi(8))*...
    Rz(Q(3)+Pi(3))*...
    Ry(Q(4)+Pi(4))*Tz(Pi(9))*...
    Rzd(Q(5)+Pi(5))*...
    Ry(Q(6)+Pi(6))*...
    Rz(Q(7)+Pi(7))*...
    Ttool*T0;
% J5 = [Td(1,4), Td(2,4), Td(3,4), Td(3,2), Td(1,3), Td(2,1)]' ;
J5 = [Td(1,4), Td(2,4), Td(3,4)]' ;

Td = Tbase*...
    Rz(Q(1)+Pi(1))*...
    Ry(Q(2)+Pi(2))*Tz(Pi(8))*...
    Rz(Q(3)+Pi(3))*...
    Ry(Q(4)+Pi(4))*Tz(Pi(9))*...
    Rz(Q(5)+Pi(5))*...
    Ryd(Q(6)+Pi(6))*...
    Rz(Q(7)+Pi(7))*...
    Ttool*T0;
% J6 = [Td(1,4), Td(2,4), Td(3,4), Td(3,2), Td(1,3), Td(2,1)]' ;
J6 = [Td(1,4), Td(2,4), Td(3,4)]' ;

Td = Tbase*...
    Rz(Q(1)+Pi(1))*...
    Ry(Q(2)+Pi(2))*Tz(Pi(8))*...
    Rz(Q(3)+Pi(3))*...
    Ry(Q(4)+Pi(4))*Tz(Pi(9))*...
    Rz(Q(5)+Pi(5))*...
    Ry(Q(6)+Pi(6))*...
    Rzd(Q(7)+Pi(7))*...
    Ttool*T0;
% J7 = [Td(1,4), Td(2,4), Td(3,4), Td(3,2), Td(1,3), Td(2,1)]' ;
J7 = [Td(1,4), Td(2,4), Td(3,4)]' ;

out = [J1 J2 J3 J4 J5 J6 J7];
end